"use strict";function preload(){background(0);var n=getURLParams();n.useKinect!=undefined&&(useKinect=!0,Connector.connect());isDebug=n.debug==undefined?!1:!0;n.step!=undefined&&(GalleryParams.stepSize=int(n.step));n.useSpeech!=undefined&&(GalleryParams.useSpeech=!0);n.noiseMode!=undefined&&(GalleryParams.noiseMode=int(n.noiseMode));n.curveMode!=undefined&&(GalleryParams.curveMode=int(n.curveMode));imageProvider.ACCESS_TOKEN="AAXgtjIzTbMAAAAAAAAqeSEVYVuB8HniFMxBBUlYaqVbLuPu1BJo5KmZH_KO9UxN";imageProvider.BASE_FOLDER="/apps/Interactive Gallery/";imageProvider.listFolders().then(n=>imageProvider.listFoldersContinue(n)).then(n=>imageProvider.getAllImages(n)).then(()=>loadNextImage());$("#btnConnect").click(function(){Connector.connect()});$("#btnDisconnect").click(function(){kinectWorker.postMessage("disconnect")})}function loadNextImage(){imageProvider.galleryImagesCount!==0&&imageProvider.GetNextImage().then(n=>processImage(n))}function processImage(n){n!==undefined&&n!==null&&n.blobUrl!==undefined&&(imgBuffer=loadImage(n.blobUrl,()=>{imgBuffer.height>windowHeight&&imgBuffer.resize(windowHeight,0),imgBuffer.loadPixels(),currentImg===undefined&&(currentImg=imgBuffer,currentImgAuthor=n.author,widthC=imgBuffer.width/windowWidth,heightC=imgBuffer.height/windowHeight,imgBuffer=undefined,$("#imgLoading").hide(),startInteraction())}))}function setup(){createCanvas(windowWidth,windowHeight);background(0);GalleryParams.useSpeech&&(speechClientForGallery=new SpeechClient("34f081c339f44da49be61d1ca6c2bb29","",""),speechClientForGallery.start(),speechClientForGallery.onPartialResponseReceived=function(n){console.log(n)},speechClientForGallery.onFinalResponseReceived=function(n){console.log(JSON.stringify(n))},speechClientForGallery.onIntentReceived=function(n){console.log(n)});currentMousePos=createVector(0,0)}function reloadImageLoop(){background(0);window.ANIMATION_ENABLED=!0;$("#progressbart").width(0);$("#imgAuthor").css("opacity",0);$("#imgAuthor").css("background","RGBA(0, 0, 0, 0)");setTimeout(function(){imageProvider.nextImage!==undefined&&$("#imgAuthor").text(imageProvider.nextImage.author);$("#progressbart").velocity({width:"100%"},{duration:GalleryParams.progressBarDuration,easing:"easeOutExpo"});$("#imgAuthor").velocity({opacity:"1"},{duration:GalleryParams.progressBarDuration,easing:"easeOutExpo"});window.setTimeout(function(){window.ANIMATION_ENABLED=!1;$("#progressbart").width(0);loadNextImage();window.setTimeout(function(){reloadImageLoop();currentImg=imgBuffer;widthC=currentImg.width/windowWidth;heightC=currentImg.height/windowHeight},4500)},GalleryParams.progressBarDuration)},GalleryParams.interactionDuration)}function draw(){var n;if((depthImage&&image(depthImage,0,0),mouseX!==undefined)&&currentImg!==undefined){if(mouseVectorPos=createVector(mouseX,mouseY),window.ANIMATION_ENABLED===!1){tint_v===undefined&&(tint_v=0);tint_v<=255?tint_v+=IMAGE_FADEIN_STEP:tint_v-=IMAGE_FADEIN_STEP;tint(255,constrain(Math.round(tint_v),0,255));image(currentImg,0,0,width,height);return}for(isDebug&useKinect&&(fill(255),rect(10,5,200,30),fill(0),text("Kinect Left-hand: "+KINECT_LEFT_X+","+KINECT_LEFT_Y,20,20),text("Kinect Right-hand: "+KINECT_RIGHT_X+","+KINECT_RIGHT_Y,20,30),fill(0,255,0),ellipse(KINECT_LEFT_X,KINECT_LEFT_Y,30,30),fill(255,255,0),ellipse(KINECT_RIGHT_X,KINECT_RIGHT_Y,30,30)),noStroke(),fill(0,0,0,100),KINECT_LEFT_X===null||KINECT_RIGHT_X===null?isKinectConnected=!1:(isKinectConnected=!0,nTouches=2),isKinectConnected||(mouseXc=round(mouseX*widthC),mouseYc=round(mouseY*heightC)),n=0;n<depthArrayBufferDVbyteLength;n+=6*GalleryParams.stepSize){var t=Math.round(depthArrayBufferDV.getUint16(n,!0)/512*currentImg.width),u=Math.round(depthArrayBufferDV.getUint16(n+2,!0)/424*currentImg.height),f=Math.round(depthArrayBufferDV.getUint16(n+4,!0)/1e3*255);noiseValue=1;switch(GalleryParams.noiseMode){case 1:noiseValue+=noise(t,u,millis());break;case 2:noiseValue+=0;break;case 3:noiseValue+=noise(sin(millis()),millis())}i=4*(u*currentImg.width+t);r=currentImg.pixels[i];g=currentImg.pixels[i+1];b=currentImg.pixels[i+2];a=255*(1-smoothstep(0,1,distanceSq/rFlashlightSq));distanceSq>.75*rFlashlightSq&&(a=r*smoothstep(0,1,distanceSq/rFlashlightSq));perceivedLum=sqrt(.299*r^2+.587*g^2+.114*b^2);perceivedLum=perceivedLum*noiseValue;radius=10*constrain(perceivedLum/10,1,2);fill(color(r,g,b,f));GalleryParams.curveMode===3?triangle2(t/widthC,u/heightC,radius):ellipse(t/widthC,u/heightC,radius,radius)}mouseVectorPos=createVector(mouseX,mouseY)}}function triangle2(n,t,i){var r=n-i,u=t-i,f=n+i,e=t-i,o=n,s=t+i;push();triangle(r,u,f,e,o,s);rotate(HALF_PI+acos(millis()/1e3));triangle(r,u,f,e,o,s);pop()}function smoothstep(n,t,i){var r=Math.max(0,Math.min(1,(i-n)/(t-n)));return r*r*(3-2*r)}function distanceF(n,t,i,r,u,f,e){var h,o,s,c,l,a,v;switch(GalleryParams.curveMode){case 1:return sq(n-i)+f*sq(t-r);case 2:return n=n+f*5*(2*sin(e/300)-1)*(t-r)/r,h=sq(1.8*(n-i))+sq(t-r+.9*u),o=atan2(50*(i-n),2.5*(r-t)),o=o+PI,s=7,c=sq(1.1*u*(cos(o)-1))+sq(u*sin(o)*pow(sin(.5*o),s)),n=n+f*5*(2*sin(e/250)-1)*(t-r)/r,h=sq(1.8*(n-i))+sq(t-r+.9*u),o=atan2(50*(i-n),2*(r-t)),o=o+PI,s=7,l=sq(1.1*u*(cos(o)-1))+sq(u*sin(o)*pow(sin(.5*o),s)),n=n+f*5*(2*sin(e/400)-1)*(t-r)/r,h=sq(1.8*(n-i))+sq(t-r+.9*u),o=atan2(40*(i-n),2.8*(r-t)),o=o+PI,s=7,a=sq(1.1*u*(cos(o)-1))+sq(u*sin(o)*pow(sin(.5*o),s)),v=Math.max(c,l,a),h/v;default:return!1}}function windowResized(){resizeCanvas(windowWidth,windowHeight);background(0)}function touchStarted(){}var KinectMessageType={INFORMATION:1,ERROR:2,GESTUREDETECTED:3,JOINTPOSITION:4,DEPTH:5},isDebug=!1,useKinect=!1,isKinectConnected=!1,KINECT_LEFT_X=0,KINECT_LEFT_Y=0,KINECT_RIGHT_X=0,KINECT_RIGHT_Y=0,mouseVectorPos,currentMousePos,tint_v,IMAGE_FADEIN_STEP;window.ANIMATION_ENABLED=!0;IMAGE_FADEIN_STEP=.35;document.ontouchmove=function(n){isDebug===!1&&n.preventDefault()};var currentImg,currentImgAuthor,imgBuffer,slider,speechClientForGallery,GalleryParams={progressBarDuration:5e3,interactionDuration:1e4,stepSize:8,noiseMode:1,curveMode:1,useSpeech:0},imageProvider=new GalleryImgProvider,depthImage,blobUrlPrevious,widthC,heightC,kinectWorker=new Worker("kinectWorker.js"),depthArrayBufferDV,depthArrayBufferDVbyteLength=0,nTouches=1;kinectWorker.onerror=function(n){console.log(n);$("#spanStatus").text(n);$("#topBar").show()};kinectWorker.onmessage=function(n){var t,i,r;if(n.data.err)throw new Error(n.data.err);n.data.depthArrayBuffer;n.data instanceof ArrayBuffer&&(t=new DataView(n.data),i=t.getUint8(0,!0),i===KinectMessageType.JOINTPOSITION?(KINECT_LEFT_X=t.getFloat32(1,!0).toFixed(4),KINECT_LEFT_Y=t.getFloat32(5,!0).toFixed(4),KINECT_RIGHT_X=t.getFloat32(9,!0).toFixed(4),KINECT_RIGHT_Y=t.getFloat32(13,!0).toFixed(4)):i===KinectMessageType.DEPTH&&(depthArrayBufferDV=new DataView(n.data.slice(2)),depthArrayBufferDVbyteLength=depthArrayBufferDV.byteLength));n.data.status&&($("#message").text(n.data.status),n.data.status==="Connected"&&($("#topBar").css("background-color","").css("background-color","greenyellow"),$("#spanStatus").text("connected!"),window.setTimeout(function(){$("#topBar").hide()},2e3),isDebug!==undefined&&isDebug===!0&&(r=$.tooltipster.instances($("#spanBackground")),r[0].content(n.data.status),toolTipOpenAndClose())))};var startInteraction=function(){var n=!1;return function(){n||(n=!0,window.ANIMATION_ENABLED=!0,reloadImageLoop())}}(),i=0,r=0,g=0,b=0,a=0,perceivedLum=0,noiseValue=0,distanceSq=0,radius=0,mouseXc=0,mouseYc=0,rFlashlight=100,rFlashlightSq=rFlashlight*rFlashlight;